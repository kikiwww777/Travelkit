<!--pages/cooperative-trip-create/cooperative-trip-create.wxml-->
<view class="trip-create-page">
  <!-- 1. æå…‰èƒŒæ™¯å±‚ (Dynamic Background) -->
  <view class="aurora-bg">
    <view class="blob blob-1"></view>
    <view class="blob blob-2"></view>
    <view class="blob blob-3"></view>
  </view>

  <view class="content-container">
    <!-- 1.5. è¡Œç¨‹åç§°è¾“å…¥ -->
    <view class="section mb-60">
      <view class="section-label">
        <view class="icon-tag"></view> è¡Œç¨‹åç§° <text class="label-en">TRIP NAME</text>
        <button bindtap="reflash" style="width: 100px; color: green; background-color: azure;">åˆ·æ–°</button>
      </view>
      <view class="trip-name-wrapper">
        <input 
          class="trip-name-input" 
          placeholder="ç»™è¡Œç¨‹èµ·ä¸ªå¥½å¬çš„åå­—..." 
          placeholder-class="trip-name-placeholder"
          value="{{tripForm.name}}"
          bindinput="onTripNameInput"
        />
      </view>
    </view>

    <!-- 2. ç›®çš„åœ°è¾“å…¥ (Hero Input) -->
    <view class="section mb-60">
      <view class="section-label">
        <view class="icon-pin"></view> ç›®çš„åœ° <text class="label-en">DESTINATION</text>
        <view wx:if="{{tripForm.destination}}" class="input-badge">å·²é€‰æ‹©ï¼š{{tripForm.destination}}</view>
        <view wx:else class="destination-confirm {{destinationFocused ? 'show' : ''}}" catchtap="queryCityList">
          ç¡®è®¤
        </view>
      </view>
      <view class="hero-input-wrapper">
        <input 
          class="hero-input" 
          placeholder="ä¸€èµ·å»å“ªå„¿ï¼Ÿ" 
          placeholder-class="hero-placeholder"
          value="{{cityQuery}}"
          bindinput="onDestinationInput"
          bindfocus="onDestinationFocus"
          bindblur="onDestinationBlur"
          bindconfirm="queryCityList"
          confirm-type="search"
        />
      </view>
    </view>

    <!-- 3. æ§åˆ¶å°å¡ç‰‡ (Control Deck: Dates & Travelers) -->
    <view class="control-deck mb-60">
      <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šæ—¥æœŸ -->
      <view class="deck-row date-row">
        <!-- å‡ºå‘ -->
        <view class="date-item border-right">
          <view class="sub-label">å‡ºå‘ <text class="sub-en">START</text></view>
          <picker mode="date" value="{{tripForm.startDate}}" bindchange="onStartDateChange" class="picker-box">
            <view class="picker-value">
              {{formattedStartDate || 'é€‰æ‹©æ—¥æœŸ'}} <view class="icon-chevron-down"></view>
            </view>
          </picker>
        </view>
        <!-- è¿”ç¨‹ -->
        <view class="date-item">
          <view class="sub-label">è¿”ç¨‹ <text class="sub-en">END</text></view>
          <picker mode="date" value="{{tripForm.endDate}}" bindchange="onEndDateChange" disabled="{{!tripForm.startDate}}" class="picker-box">
            <view class="picker-value">
              {{formattedEndDate || 'é€‰æ‹©æ—¥æœŸ'}} <view class="icon-chevron-down"></view>
            </view>
          </picker>
        </view>
      </view>
      
      <!-- åˆ†å‰²çº¿ -->
      <view class="deck-divider"></view>
      <!-- ä¸‹åŠéƒ¨åˆ†ï¼šäººæ•° -->
      <view class="deck-row traveler-row">
        <view class="traveler-info">
          <view class="sub-label">åŒè¡Œä¼™ä¼´ <text class="sub-en">TRAVELERS</text></view>
          <view class="traveler-desc">ä¸è°åŒè¡Œ</view>
        </view>
        
        <!-- è®¡æ•°å™¨èƒ¶å›Š -->
        <view class="counter-capsule">
          <view class="counter-btn" catchtap="onDecrease">-</view>
          <view class="counter-num">{{tripForm.travelers || 1}}</view>
          <view class="counter-btn" catchtap="onIncrease">+</view>
        </view>
      </view>
    </view>

    <!-- 4. å‡ºè¡Œç±»å‹ (Mode Grid) -->
    <view class="section mb-60">
      <view class="section-label">
        <view class="icon-compass"></view> å‡ºè¡Œç±»å‹ <text class="label-en">MODE</text>
      </view>
      <view class="mode-grid">
        <!-- æ—…æ¸¸ -->
        <view class="mode-card {{tripForm.type === 'tourism' ? 'active' : ''}}" catchtap="selectMode" data-mode="tourism">
          <view class="mode-icon {{tripForm.type === 'tourism' ? 'icon-tourism-white' : 'icon-tourism'}}"></view>
          <text class="mode-text">æ—…æ¸¸</text>
        </view>
        <!-- å•†åŠ¡ -->
        <view class="mode-card {{tripForm.type === 'business' ? 'active' : ''}}" catchtap="selectMode" data-mode="business">
          <view class="mode-icon icon-business"></view>
          <text class="mode-text">å•†åŠ¡</text>
        </view>
        <!-- æ¢äº² -->
        <view class="mode-card {{tripForm.type === 'family' ? 'active' : ''}}" catchtap="selectMode" data-mode="family">
          <view class="mode-icon icon-family"></view>
          <text class="mode-text">æ¢äº²</text>
        </view>
        <!-- å…¶ä»– -->
        <view class="mode-card {{tripForm.type === 'other' ? 'active' : ''}}" catchtap="selectMode" data-mode="other">
          <view class="mode-icon icon-other"></view>
          <text class="mode-text">å…¶ä»–</text>
        </view>
      </view>
    </view>

    <!-- 5. è¡Œç¨‹æ¨¡æ¿ (Ticket Style) -->
    <view class="section mb-60">
      <view class="section-label">
        <view class="icon-template"></view> è¡Œç¨‹æ¨¡æ¿ <text class="label-en">TEMPLATE</text>
      </view>
      <picker 
        mode="selector" 
        range="{{templates}}" 
        range-key="displayName"
        value="{{templateIndex}}"
        bindchange="handleTemplateChange"
        disabled="{{templates.length === 0}}"
      >
        <view class="template-ticket">
          <view class="ticket-bg-pattern"></view>
          <view class="ticket-content">
            <view>
              <view class="sub-label">å·²é€‰æ–¹æ¡ˆ <text class="sub-en">SELECTED</text></view>
              <view class="ticket-value">{{selectedTemplate ? (selectedTemplate.displayName || selectedTemplate.name) : (templates.length > 0 ? 'é€‰æ‹©è¡Œç¨‹æ¨¡æ¿' : 'æš‚æ— å¯ç”¨æ¨¡æ¿')}}</view>
            </view>
            <view class="ticket-icon-wrap">
              <view class="icon-sliders"></view>
            </view>
          </view>
        </view>
      </picker>
      
      <!-- æ¨¡æ¿ç‰©å“é¢„è§ˆ -->
      <view wx:if="{{selectedTemplate && templateItems.length > 0}}" class="template-preview-section">
        <view class="template-items-count">åŒ…å« {{templateItems.length}} ä¸ªç‰©å“</view>
        <view class="template-items-preview">
          <view 
            class="template-item-preview"
            wx:for="{{templateItemsPreview}}" 
            wx:key="id"
          >
            <text class="item-icon">âœ“</text>
            <text class="item-name">{{item.name}}</text>
          </view>
          <view wx:if="{{templateItems.length > 10}}" class="template-items-more">
            è¿˜æœ‰ {{templateItems.length - 10}} ä¸ªç‰©å“...
          </view>
        </view>
        <view class="template-items-tip">
          <text>ğŸ’¡ åˆ›å»ºè¡Œç¨‹åï¼Œè¿™äº›ç‰©å“å°†è‡ªåŠ¨æ·»åŠ åˆ°ç‰©å“æ¸…å•ä¸­ï¼Œå¯é‚€è¯·å¥½å‹ä¸€èµ·æŸ¥éªŒ</text>
        </view>
      </view>
    </view>

    <!-- 6. è¾“å…¥åŒºåŸŸ -->
    <view class="input-stack mb-100">
      <view class="text-card">
        <view class="card-icon icon-file"></view>
        <textarea 
          class="clean-textarea" 
          placeholder="è¡Œç¨‹æè¿°ï¼šä¾‹å¦‚å…·ä½“çš„ä¼šè®®æ—¶é—´ã€æƒ³å»çš„æ™¯ç‚¹..." 
          value="{{tripForm.description}}"
          bindinput="onDescriptionInput"
          maxlength="200"
        />
      </view>
      <view class="text-card">
        <view class="card-icon icon-heart"></view>
        <textarea 
          class="clean-textarea" 
          placeholder="ç‰¹æ®Šéœ€æ±‚ï¼šä¾‹å¦‚éœ€è¦å©´å„¿è½¦ã€æ™•è½¦è¯ã€è¿‡æ•æº..." 
          value="{{tripForm.specialNeeds}}"
          bindinput="onSpecialNeedsInput"
          maxlength="200"
        />
      </view>
    </view>

    <!-- åŸå¸‚å›¾ç‰‡ -->
    <view wx:if="{{cityPictureUrl || loadingPicture || pictureError}}" class="section mb-60">
      <view class="section-label">
        <view class="icon-pin"></view> åŸå¸‚å›¾ç‰‡ <text class="label-en">PICTURE</text>
      </view>
      <view wx:if="{{loadingPicture}}" class="picture-loading-card">
        <text>æ­£åœ¨åŠ è½½åŸå¸‚å›¾ç‰‡...</text>
      </view>
      <view wx:elif="{{cityPictureUrl}}" class="picture-card-new">
        <view class="picture-wrapper-new" bindtap="previewCityPicture">
          <image 
            class="city-picture-new" 
            src="{{cityPictureUrl}}" 
            mode="aspectFill" 
            binderror="handlePictureError"
          />
        </view>
        <view wx:if="{{cityPictureList.length > 1}}" class="picture-thumbnails-new">
          <image 
            wx:for="{{cityPictureList}}" 
            wx:key="*this" 
            class="thumbnail-new {{item === cityPictureUrl ? 'active' : ''}}" 
            src="{{item}}" 
            mode="aspectFill"
            data-url="{{item}}"
            bindtap="switchCityPicture"
          />
        </view>
        <view class="picture-actions">
          <text>{{tripForm.destination || 'æœªé€‰æ‹©ç›®çš„åœ°'}}</text>
          <button class="refresh-btn" bindtap="refreshCityPicture">é‡æ–°ç”Ÿæˆ</button>
        </view>
      </view>
      <view wx:elif="{{pictureError}}" class="picture-error-card">
        <text>{{pictureError}}</text>
        <button class="refresh-btn" bindtap="refreshCityPicture">é‡æ–°å°è¯•</button>
      </view>
    </view>

    <!-- å¤©æ°”é¢„æŠ¥ -->
    <view wx:if="{{weatherForecast30d || loadingWeather}}" class="section mb-60">
      <view class="section-label">
        <view class="icon-pin"></view> ç›®çš„åœ°å¤©æ°” <text class="label-en">WEATHER</text>
      </view>
      <view wx:if="{{loadingWeather}}" class="weather-loading-card">
        <text>åŠ è½½å¤©æ°”ä¿¡æ¯ä¸­...</text>
      </view>
      <view wx:elif="{{weatherForecast30d && weatherForecast30d.forecast && weatherForecast30d.forecast.length > 0}}" class="weather-content-new">
        <view class="weather-city-new">{{weatherForecast30d.city}}</view>
        <scroll-view class="weather-forecast-new" scroll-x="true">
          <view class="forecast-list-new">
            <view 
              class="forecast-item-new {{item.isInTripRange ? 'is-trip-date' : ''}}"
              wx:for="{{weatherForecast30d.forecast}}" 
              wx:for-index="idx"
              wx:key="date"
            >
              <text class="forecast-date-new">{{item.formattedDate}}</text>
              <view class="forecast-info-new">
                <view class="forecast-icons-new">
                  <image wx:if="{{item.iconDay}}" class="forecast-icon-new" src="{{item.iconDay}}" mode="aspectFit" data-index="{{idx}}" binderror="handleWeatherIconError" />
                </view>
                <view class="forecast-temp-new">
                  <text class="temp-max-new">{{item.tempMax}}Â°</text>
                  <text class="temp-min-new">/ {{item.tempMin}}Â°</text>
                </view>
                <view class="forecast-text-new">{{item.textDay}}</view>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>
      <view wx:elif="{{weatherError}}" class="weather-error-card">
        <text>âš ï¸ {{weatherError}}</text>
      </view>
    </view>
    
    <!-- åº•éƒ¨å ä½ï¼Œé˜²æ­¢å†…å®¹è¢«æŒ‰é’®æŒ¡ä½ -->
    <view style="height: 180rpx;"></view>
  </view>

  <!-- 7. æ‚¬æµ®å¯åŠ¨æŒ‰é’® (AI Launch Button) -->
  <view class="bottom-floater">
    <button class="launch-btn" hover-class="launch-btn-hover" loading="{{loading}}" bindtap="handleCreate">
      <view class="btn-left">
        <view class="ai-tag">COOPERATIVE</view>
        <view class="btn-title">åˆ›å»ºåˆä½œè¡Œç¨‹</view>
      </view>
      <view class="icon-arrow-right"></view>
    </button>
  </view>

  <!-- åŸå¸‚é€‰æ‹©å¼¹çª— -->
  <view wx:if="{{cityDialogVisible}}" class="city-dialog-mask" bindtap="confirmSelectCity">
    <view class="city-dialog" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">é€‰æ‹©ç›®çš„åœ°åŸå¸‚</text>
        <text class="dialog-close" bindtap="confirmSelectCity">Ã—</text>
      </view>
      <view class="dialog-content">
        <view wx:if="{{cityLoading}}" class="loading-state">
          <text>åŠ è½½åŸå¸‚åˆ—è¡¨...</text>
        </view>
        <view wx:else>
          <view 
            class="city-item {{selectedCityId === item.id ? 'selected' : ''}}" 
            wx:for="{{cityList}}" 
            wx:key="id"
            bindtap="handleSelectCityRow"
            data-city="{{item}}"
            data-id="{{item.id}}"
          >
            <text class="city-name">{{item.name}}</text>
            <text class="city-region">{{item.adm1 || ''}}{{item.adm1 && item.adm2 ? 'Â·' : ''}}{{item.adm2 || ''}}</text>
            <!-- <text wx:if="{{selectedCityId === item.id}}" class="city-selected-icon">âœ“</text> -->
          </view>
          <view wx:if="{{cityList.length === 0}}" class="empty-state">
            <text>æš‚æ— æ•°æ®</text>
          </view>
        </view>
      </view>
      <view class="dialog-footer">
        <button class="dialog-btn" bindtap="closeCityDialog">å–æ¶ˆ</button>
        <button class="dialog-btn primary" bindtap="confirmSelectCity" disabled="{{!selectedCityId}}">ç¡®è®¤</button>
      </view>
    </view>
  </view>
</view>
