<!--pages/cooperative-check-process/cooperative-check-process.wxml-->
<view class="container">
  <view wx:if="{{loading}}" class="loading-state">
    <text>åŠ è½½ä¸­...</text>
  </view>
  
  <view wx:else>
    <!-- ================= 1. åŠ¨æ€æ°´ä½èƒŒæ™¯å±‚ ================= -->
    <view class="liquid-wrapper">
      <!-- æ•´ä¸ªæ°´ä½å®¹å™¨ -->
      <view 
        class="liquid-level" 
        style="height: {{isCompleted ? '100%' : displayProgress + '%'}}"
      >
        <!-- A. æ³¢æµªå±‚ (ä½¿ç”¨ CSS èƒŒæ™¯å›¾ï¼Œä¸å†ç”¨ image æ ‡ç­¾) -->
        <view class="wave-layer {{isCompleted ? 'wave-green' : 'wave-blue'}}"></view>
        
        <!-- B. çº¯è‰²æ°´ä½“ (å¡«è¡¥ä¸‹æ–¹) -->
        <view class="liquid-solid {{isCompleted ? 'bg-green' : 'bg-blue'}}"></view>
      </view>
    </view>

    <!-- ================= 2. å†…å®¹å±‚ (æ‚¬æµ®åœ¨æ°´é¢ä¹‹ä¸Š) ================= -->
    <view class="content-wrapper" style="padding-top: {{statusBarHeight}}px;">
      
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <view class="navbar">
        <view class="nav-btn" bindtap="goBack">â€¹</view>
        <view class="nav-title">
          <text class="sub-title {{isCompleted ? 'text-green-dark' : 'text-blue-dark'}}">{{isCompleted ? 'å·²å°ç®±' : 'åˆä½œæ¸…å•'}}</text>
          <text class="main-title">{{trip.name || trip.destination || 'æœªå‘½åè¡Œç¨‹'}}</text>
        </view>
        <view class="progress-pill {{isCompleted ? 'pill-green' : 'pill-blue'}}">{{progress}}%</view>
      </view>

      <!-- æ»šåŠ¨åˆ—è¡¨åŒº -->
      <scroll-view 
        scroll-y 
        class="scroll-area" 
        enable-flex
        scroll-top="{{scrollTop}}"
        bindscroll="onScroll"
      >
        <view class="scroll-content">
          
          <!-- ================= å¾…æŸ¥éªŒåŒºåŸŸ (åˆ†ç»„æ˜¾ç¤º) ================= -->
          <!-- å¦‚æœéƒ½å®Œæˆäº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€ -->
          <view wx:if="{{isAllChecked && !isCompleted}}" class="empty-tip">
            ğŸ‰ æ‰€æœ‰ç‰©å“å·²å‡†å¤‡å°±ç»ªï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹å°ç®±
          </view>

          <!-- å¾ªç¯æ¸²æŸ“åˆ†ç±» -->
          <block wx:else>
            <block wx:for="{{categories}}" wx:for-item="cat" wx:key="name">
              <view class="category-section">
                <!-- åˆ†ç±»æ ‡é¢˜å¤´ -->
                <view class="category-header">
                  <image class="category-icon" src="{{cat.config.icon}}" mode="aspectFit" />
                  <text class="category-name" style="color: {{cat.config.color}}">{{cat.name}}</text>
                  <view class="category-line"></view>
                </view>

                <!-- è¯¥åˆ†ç±»ä¸‹çš„ç‰©å“å¡ç‰‡ (Grid å¸ƒå±€) -->
                <view class="card-grid">
                  <block wx:for="{{cat.items}}" wx:for-item="item" wx:key="id">
                    <view 
                      class="item-card white-card"
                      bindtap="toggleItem"
                      data-id="{{item.id}}"
                    >
                      <!-- å›¾æ ‡é¢œè‰²åœ†ç‚¹ -->
                      <view class="cat-dot" style="background-color: {{cat.config.bg}};">
                        <image class="cat-dot-icon" src="{{cat.config.icon}}" mode="aspectFit" />
                      </view>
                      <text class="card-name">{{item.name}}</text>
                      <view class="checkbox-circle"></view>
                    </view>
                  </block>
                </view>
              </view>
            </block>
          </block>

          <!-- ================= å·²è£…ç®±åŒºåŸŸ (æ°”æ³¡æ²‰åº•) ================= -->
          <block wx:if="{{hasCheckedItems}}">
            <view class="section-header" style="margin-top: 60rpx;">
              <text class="section-title text-white-shadow">å·²è£…ç®± ({{checkedCount}})</text>
            </view>
            <view class="card-grid">
              <block wx:for="{{checklist}}" wx:key="id">
                <!-- åªæ˜¾ç¤ºå·²æŸ¥éªŒçš„ (checked === 1) -->
                <view 
                  wx:if="{{item.checked === 1}}" 
                  class="item-card bubble-card"
                  bindtap="toggleItem"
                  data-id="{{item.id}}"
                >
                  <view class="icon-check">âœ“</view>
                  <text class="card-name text-white">{{item.name}}</text>
                </view>
              </block>
            </view>
          </block>

          <view style="height: 200rpx;"></view> <!-- åº•éƒ¨å«é«˜ -->
        </view>
      </scroll-view>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="bottom-bar">
        <button 
          wx:if="{{!isCompleted}}"
          class="action-btn {{isAllChecked ? 'btn-active' : 'btn-disabled'}}" 
          bindtap="{{isAllChecked ? 'completeTrip' : ''}}"
        >
          {{isAllChecked ? 'ğŸ“¦ ç¡®è®¤æ‰“åŒ…å®Œæˆ' : 'è¯·å…ˆå‹¾é€‰æ‰€æœ‰ç‰©å“'}}
        </button>

        <button 
          wx:else
          class="action-btn btn-green" 
          bindtap="reactivateTrip"
        >
          ğŸ”“ é‡æ–°æ¿€æ´»æ¸…å•
        </button>
      </view>
    </view>
  </view>
</view>
