<!--pages/profile/profile.wxml-->
<view class="profile-container">
  
  <!-- ==================== Profile Card & Stats ==================== -->
  <view class="profile-card">
    <!-- Decorative Bg -->
    <view class="deco-bg"></view>

    <!-- Header Content -->
    <view class="profile-header">
      <view class="avatar-wrapper">
        <!-- Gradient Border -->
        <view class="avatar-border">
          <view class="avatar-inner">
            <image 
              wx:if="{{userInfo.avatar}}"
              src="{{userInfo.avatar}}" 
              class="avatar-img" 
              mode="aspectFill"
              bindtap="onAvatarTap"
            />
            <view wx:else class="avatar-placeholder" bindtap="onAvatarTap">ğŸ‘¤</view>
          </view>
        </view>
      </view>

      <view class="user-info">
        <view class="user-name">{{userProfile.name || userInfo.name || 'æœªè®¾ç½®'}}</view>
        <view class="tags-row">
          <view class="tag" wx:if="{{userProfile.gender || userInfo.gender}}">
            <text>{{(userProfile.gender || userInfo.gender) === 'ç”·' ? 'ğŸ‘¨ ç”·' : 'ğŸ‘© å¥³'}}</text>
          </view>
          <view class="tag" wx:if="{{userProfile.birthday || userInfo.birthday}}">
            <text>{{constellation || 'å·¨èŸ¹åº§'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Stats Row -->
    <view class="stats-row">
      <view class="stat-item border-r">
        <view class="stat-num text-sky">{{stats.totalTrips || 0}}</view>
        <view class="stat-label">æ€»è¡Œç¨‹æ•°</view>
      </view>
      <view class="stat-item border-r">
        <view class="stat-num text-emerald">{{stats.completedTrips || 0}}</view>
        <view class="stat-label">å·²å®Œæˆ</view>
      </view>
      <view class="stat-item">
        <view class="stat-num text-dark">{{stats.days || 0}}</view>
        <view class="stat-label">å‡ºè¡Œå¤©æ•°</view>
      </view>
    </view>
  </view>

  <!-- ==================== Form Section ==================== -->
  <view class="form-section">
    <view class="section-title">
      <image class="icon-user" src="{{iconUser}}" /> 
      <text>ä¸ªäººä¿¡æ¯</text>
      <!-- Edit Button -->
      <view 
        class="edit-btn {{isProfileEditing ? 'btn-active' : 'btn-normal'}}" 
        bindtap="toggleEdit"
      >
        <image class="icon-sm" src="{{isProfileEditing ? iconCheck : iconPen}}" />
      </view>
    </view>

    <view class="form-card">
      
      <!-- Name Field -->
      <view class="form-item border-b">
        <text class="form-label">å§“å NAME</text>
        <input 
          class="form-input {{isProfileEditing ? 'input-active' : ''}}"
          value="{{userProfile.name || userInfo.name}}"
          disabled="{{!isProfileEditing}}"
          bindinput="handleNameInput"
          placeholder="è¯·è¾“å…¥å§“å"
          placeholder-class="placeholder-style"
        />
      </view>

      <!-- Gender Field (Picker) -->
      <view class="form-item border-b">
        <text class="form-label">æ€§åˆ« GENDER</text>
        <picker 
          mode="selector" 
          range="{{['ç”·', 'å¥³']}}" 
          value="{{(userProfile.gender || userInfo.gender) === 'ç”·' ? 0 : 1}}"
          disabled="{{!isProfileEditing}}"
          bindchange="handleGenderChange"
        >
          <view class="picker-inner">
            <text class="form-input {{isProfileEditing ? 'input-active' : ''}}">{{userProfile.gender || userInfo.gender || 'è¯·é€‰æ‹©'}}</text>
            <image wx:if="{{isProfileEditing}}" class="icon-chevron" src="{{iconChevronDown}}" />
          </view>
        </picker>
      </view>

      <!-- Birthday Field (Picker) -->
      <view class="form-item border-b">
        <text class="form-label">ç”Ÿæ—¥ BIRTHDAY</text>
        <picker 
          mode="date" 
          value="{{userProfile.birthday || userInfo.birthday}}"
          start="1900-01-01"
          end="{{maxDate}}"
          disabled="{{!isProfileEditing}}"
          bindchange="handleDateChange"
        >
          <view class="form-input {{isProfileEditing ? 'input-active' : ''}}">
            {{displayBirthday || userProfile.birthday || userInfo.birthday || 'è¯·é€‰æ‹©ç”Ÿæ—¥'}}
          </view>
        </picker>
      </view>

      <!-- Bio Field -->
      <view class="form-item">
        <text class="form-label">ä¸ªäººç®€ä»‹ BIO</text>
        <textarea 
          class="form-textarea {{isProfileEditing ? 'input-active' : ''}}"
          value="{{userProfile.bio || userInfo.bio}}"
          disabled="{{!isProfileEditing}}"
          bindinput="handleBioInput"
          auto-height
          maxlength="100"
          placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§..."
          placeholder-class="placeholder-style"
        />
      </view>

    </view>
  </view>
 <!-- é€€å‡ºæŒ‰é’® -->
 <view class="save-section">
    <button 
      class="save-btn"
      style="position: absolute; right:15px;top:20px ; width: 120px;height: 35px;"     
      bindtap="logout"
    >
           <text>é€€å‡ºç™»å½•</text>
    </button>
  </view>
  <view class="save-section" wx:if="{{userInfo.identity === 1}}"   bindtap="goToAdmin">
    <button 
      class="save-btn"
      style="position: absolute; right:140px;top:20px ; width: 100px;height: 35px;"     
    >
           <text>ç®¡ç†å‘˜</text>
    </button>
  </view>
  <!-- ä¿å­˜æŒ‰é’® -->
  <view class="save-section" wx:if="{{isProfileEditing}}">
    <button 
      class="save-btn" 
      loading="{{loading}}"
      bindtap="saveProfile"
    >
      <image class="save-icon" src="{{iconCheckCircle}}" />
      <text>ä¿å­˜ä¸ªäººä¿¡æ¯</text>
    </button>
  </view>

  

  <!-- ç”Ÿæˆå›¾ç‰‡å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showPictureDialog}}" bindtap="closePictureDialog">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">ç”Ÿæˆå¤´åƒ</text>
        <text class="dialog-close" bindtap="closePictureDialog">Ã—</text>
      </view>
      <view class="dialog-body">
        <view class="keyword-input-wrapper" catchtap="stopPropagation">
          <input 
            class="keyword-input" 
            value="{{pictureKeyword}}"
            bindinput="onKeywordInput"
            placeholder="è¯·è¾“å…¥å…³é”®å­—ï¼Œå¦‚ï¼šé£æ™¯ã€äººç‰©ã€åŠ¨ç‰©ç­‰"
            catchtap="stopPropagation"
          />
          <button 
            class="generate-btn" 
            type="primary" 
            size="mini"
            loading="{{loadingPicture}}"
            bindtap="generatePicture"
          >
            ç”Ÿæˆ
          </button>
        </view>
        <view class="generated-picture-wrapper" wx:if="{{generatedPictureUrl}}">
          <image 
            class="generated-picture" 
            src="{{generatedPictureUrl}}" 
            mode="aspectFill"
          />
          <view class="picture-actions">
            <button 
              class="change-btn" 
              type="default" 
              size="mini"
              bindtap="changePicture"
            >
              æ¢ä¸€å¼ 
            </button>
            <button 
              class="confirm-btn" 
              type="primary" 
              size="mini"
              bindtap="confirmPicture"
            >
              ä½¿ç”¨
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
