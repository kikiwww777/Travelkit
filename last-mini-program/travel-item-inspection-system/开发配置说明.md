# 微信小程序开发配置说明

## 问题说明

错误 `request:fail url not in domain list` 表示请求的域名不在微信小程序的合法域名列表中。这是微信小程序的安全限制。

## 解决方案

### 方案一：开发环境 - 启用"不校验合法域名"（推荐）

在微信开发者工具中：

1. 打开微信开发者工具
2. 点击右上角的 **详情** 按钮
3. 在 **本地设置** 选项卡中
4. 勾选 **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**
5. 重新编译运行小程序

这样你就可以在开发环境中使用 `http://localhost:8080` 访问后端了。

### 方案二：使用内网穿透工具（适合真机调试）

如果你想在真机上测试，可以使用内网穿透工具：

#### 使用 ngrok：
```bash
# 安装 ngrok
# 下载地址：https://ngrok.com/

# 启动内网穿透（将本地8080端口映射到公网）
ngrok http 8080

# 会得到一个公网地址，例如：https://xxxxx.ngrok.io
```

然后在 `utils/api.js` 中修改 BASE_URL：
```javascript
const BASE_URL = 'https://xxxxx.ngrok.io'; // 使用 ngrok 提供的地址
```

#### 使用其他内网穿透工具：
- **natapp**: https://natapp.cn/
- **花生壳**: https://hsk.oray.com/
- **cpolar**: https://www.cpolar.com/

### 方案三：使用局域网IP（仅开发环境）

如果你的电脑和测试设备在同一个局域网：

1. 查看你的电脑IP地址：
   - Windows: 打开命令提示符，输入 `ipconfig`，找到 IPv4 地址
   - Mac/Linux: 打开终端，输入 `ifconfig`，找到 inet 地址

2. 在 `utils/api.js` 中修改 BASE_URL：
```javascript
const BASE_URL = 'http://192.168.x.x:8080'; // 替换为你的实际IP地址
```

3. 确保后端服务允许外部访问：
   - 在 `Check/src/main/resources/application.yml` 中，确保没有限制访问IP
   - Spring Boot 默认监听 `0.0.0.0:8080`，应该可以直接访问

### 方案四：配置正式域名（生产环境）

如果要发布小程序，需要在微信公众平台配置合法域名：

1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 进入 **开发** -> **开发管理** -> **开发设置**
3. 在 **服务器域名** 中添加：
   - **request合法域名**：添加你的后端API地址（必须是HTTPS）
   - 例如：`https://api.yourdomain.com`

4. 修改 `utils/api.js` 中的 BASE_URL：
```javascript
const BASE_URL = 'https://api.yourdomain.com'; // 生产环境地址
```

## 启动步骤

### 1. 启动后端服务

```bash
# 进入后端项目目录
cd Check

# 启动后端服务（确保MySQL已启动并配置正确）
mvn spring-boot:run
```

后端服务将在 `http://localhost:8080` 启动。

验证后端是否正常：
- 访问：http://localhost:8080/doc.html （Knife4j API文档）
- 或者访问：http://localhost:8080/api/test （测试接口）

### 2. 配置小程序开发环境

**推荐方式**：在微信开发者工具中启用"不校验合法域名"

1. 打开微信开发者工具
2. 点击右上角 **详情**
3. 在 **本地设置** 中勾选 **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**
4. 在 `utils/api.js` 中确保 BASE_URL 为：
```javascript
const BASE_URL = 'http://localhost:8080';
```

### 3. 启动小程序

在微信开发者工具中打开 `出行必带小程序` 目录，点击编译运行。

## 测试后端连接

### 测试后端API是否正常

你可以先在浏览器中测试后端API：

```bash
# 测试登录接口
curl -X POST http://localhost:8080/api/users/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'
```

### 在小程序中测试

1. 确保后端服务已启动（http://localhost:8080）
2. 确保在开发者工具中启用了"不校验合法域名"
3. 在小程序中尝试登录
4. 如果还有问题，检查：
   - 后端服务是否真的在运行
   - 控制台是否有其他错误信息
   - 网络请求是否被拦截

## 常见问题

### Q: 为什么不能用 localhost？
A: 微信小程序有安全限制，不允许直接访问 localhost。开发环境需要启用"不校验合法域名"选项。

### Q: 真机调试怎么办？
A: 使用内网穿透工具（ngrok等），或者使用局域网IP地址。

### Q: 生产环境必须用HTTPS吗？
A: 是的，微信小程序的生产环境必须使用HTTPS协议。

### Q: 如何查看小程序网络请求？
A: 在微信开发者工具中，点击 **调试器** -> **Network** 可以查看所有网络请求。

## 检查清单

- [ ] 后端服务已启动（http://localhost:8080）
- [ ] 后端API可以正常访问（浏览器测试）
- [ ] 微信开发者工具中已启用"不校验合法域名"
- [ ] `utils/api.js` 中的 BASE_URL 配置正确
- [ ] MySQL 数据库已启动并配置正确
- [ ] 数据库中已初始化数据（执行了 sql/init_database.sql）

