<!--pages/trip-create/trip-create.wxml-->
<view class="trip-create-container">
  <view class="page-header">
    <text class="page-title">åˆ›å»ºæ–°è¡Œç¨‹</text>
    <button class="back-btn" size="mini" bindtap="onCancel">è¿”å›</button>
  </view>

  <scroll-view class="form-container" scroll-y="true">
    <!-- è¡Œç¨‹ä¿¡æ¯è¡¨å• -->
    <view class="form-section">
      <view class="section-title">è¡Œç¨‹ä¿¡æ¯</view>
      
      <!-- ç¬¬ä¸€ä¸ªç›®çš„åœ°æ¡†ï¼šç¦æ­¢å¡«å†™ï¼Œä»…æ˜¾ç¤ºå·²é€‰æ‹©çš„ç›®çš„åœ° -->
      <view class="form-item">
        <text class="form-label">ç›®çš„åœ° *</text>
        <input 
          class="form-input" 
          placeholder="è¯·å…ˆæŸ¥è¯¢å¹¶é€‰æ‹©ç›®çš„åœ°"
          value="{{tripForm.destination}}"
          disabled="{{true}}"
        />
        <text wx:if="{{tripForm.destination}}" class="selected-city">å·²é€‰æ‹©ï¼š{{tripForm.destination}}</text>
      </view>

      <!-- ç¬¬äºŒä¸ªç›®çš„åœ°æ¡†ï¼šå¯ä»¥è¾“å…¥å¹¶æŸ¥è¯¢ -->
      <view class="form-item">
        <text class="form-label">æŸ¥è¯¢ç›®çš„åœ°</text>
        <view class="destination-input">
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥ç›®çš„åœ°å…³é”®è¯"
            value="{{cityQuery}}"
            bindinput="onDestinationInput"
          />
          <button class="query-btn" type="primary" size="mini" bindtap="queryCityList">æŸ¥è¯¢ç›®çš„åœ°</button>
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">å‡ºè¡Œç±»å‹ *</text>
        <picker 
          mode="selector" 
          range="{{['æ—…æ¸¸', 'å•†åŠ¡', 'æ¢äº²', 'å…¶ä»–']}}"
          value="{{typeIndex}}"
          bindchange="onTypeChange"
        >
          <view class="picker-view">
            {{typeLabel || 'è¯·é€‰æ‹©å‡ºè¡Œç±»å‹'}}
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="form-label">å‡ºå‘æ—¥æœŸ *</text>
        <picker 
          mode="date" 
          value="{{tripForm.startDate}}"
          bindchange="onStartDateChange"
        >
          <view class="picker-view">
            {{tripForm.startDate || 'è¯·é€‰æ‹©å‡ºå‘æ—¥æœŸ'}}
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="form-label">è¿”å›æ—¥æœŸ *</text>
        <picker 
          mode="date" 
          value="{{tripForm.endDate}}"
          bindchange="onEndDateChange"
          disabled="{{!tripForm.startDate}}"
        >
          <view class="picker-view">
            {{tripForm.endDate || 'è¯·é€‰æ‹©è¿”å›æ—¥æœŸ'}}
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="form-label">åŒè¡Œäººæ•°</text>
        <input 
          class="form-input" 
          type="number" 
          value="{{tripForm.travelers}}"
          bindinput="onTravelersChange"
          placeholder="è¯·è¾“å…¥åŒè¡Œäººæ•°"
        />
      </view>

      <view class="form-item">
        <text class="form-label">è¡Œç¨‹æè¿°</text>
        <textarea 
          class="form-textarea" 
          value="{{tripForm.description}}"
          bindinput="onDescriptionInput"
          placeholder="ç®€å•æè¿°ä¸€ä¸‹è¿™æ¬¡è¡Œç¨‹çš„ç›®çš„å’Œè®¡åˆ’..."
          maxlength="200"
        />
      </view>

      <view class="form-item">
        <text class="form-label">ç‰¹æ®Šéœ€æ±‚</text>
        <textarea 
          class="form-textarea" 
          value="{{tripForm.specialNeeds}}"
          bindinput="onSpecialNeedsInput"
          placeholder="å¦‚ï¼šè¿‡æ•ä½“è´¨ã€è½®æ¤…å‡ºè¡Œã€å® ç‰©åŒè¡Œç­‰ç‰¹æ®Šéœ€æ±‚"
          maxlength="200"
        />
      </view>
    </view>

    <!-- è¡Œç¨‹æ¨¡æ¿é€‰æ‹© -->
    <view class="form-section template-section">
      <view class="section-title">ğŸ“‹ é€‰æ‹©è¡Œç¨‹æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰</view>
      
      <view class="template-selector">
        <picker 
          mode="selector" 
          range="{{templates}}" 
          range-key="name"
          value="{{templateIndex}}"
          bindchange="handleTemplateChange"
          disabled="{{templates.length === 0}}"
        >
          <view class="picker-view">
            {{selectedTemplate ? selectedTemplate.name : (templates.length > 0 ? 'è¯·é€‰æ‹©è¡Œç¨‹æ¨¡æ¿' : 'æš‚æ— å¯ç”¨æ¨¡æ¿')}}
          </view>
        </picker>
      </view>

      <view wx:if="{{selectedTemplate}}" class="selected-template">
        <view class="selected-template-header">
          <text class="template-icon">ğŸ“‹</text>
          <text class="selected-template-title">å·²é€‰æ‹©æ¨¡æ¿</text>
        </view>
        <text class="selected-template-name">{{selectedTemplate.name}}</text>
        <text wx:if="{{selectedTemplate.description}}" class="selected-template-desc">{{selectedTemplate.description}}</text>
        
        <!-- æ¨¡æ¿ç‰©å“é¢„è§ˆ -->
        <view wx:if="{{loadingTemplateItems}}" class="template-items-loading">
          <text>åŠ è½½æ¨¡æ¿ç‰©å“ä¸­...</text>
        </view>
        <view wx:elif="{{templateItems.length > 0}}" class="template-items-preview">
          <view class="template-items-header">
            <text class="template-items-count">åŒ…å« {{templateItems.length}} ä¸ªç‰©å“</text>
          </view>
          <view class="template-items-list">
            <view 
              class="template-item-preview"
              wx:for="{{templateItemsPreview}}" 
              wx:key="id"
            >
              <text class="item-icon">âœ“</text>
              <text class="item-name">{{item.name}}</text>
            </view>
            <view wx:if="{{templateItems.length > 10}}" class="template-items-more">
              è¿˜æœ‰ {{templateItems.length - 10}} ä¸ªç‰©å“...
            </view>
          </view>
          <view class="template-items-tip">
            <text>ğŸ’¡ åˆ›å»ºè¡Œç¨‹åï¼Œè¿™äº›ç‰©å“å°†è‡ªåŠ¨æ·»åŠ åˆ°ç‰©å“æ¸…å•ä¸­</text>
          </view>
        </view>
        <view wx:else class="template-items-empty">
          <text>è¯¥æ¨¡æ¿æš‚æ— ç‰©å“</text>
        </view>
      </view>
    </view>

    <!-- å¤©æ°”é¢„æŠ¥ -->
    <view wx:if="{{weatherForecast30d || loadingWeather}}" class="form-section weather-section">
      <view class="section-title">â˜ï¸ ç›®çš„åœ°å¤©æ°”</view>
      <view class="weather-hint">(ä»…èƒ½å±•ç¤º30å¤©å†…å¤©æ°”)</view>
      
      <view wx:if="{{loadingWeather}}" class="weather-loading">
        <text>åŠ è½½å¤©æ°”ä¿¡æ¯ä¸­...</text>
      </view>

      <view wx:elif="{{weatherForecast30d && weatherForecast30d.forecast && weatherForecast30d.forecast.length > 0}}" class="weather-content">
        <view class="weather-city">{{weatherForecast30d.city}}</view>
        <view wx:if="{{weatherForecast30d.hasError}}" class="weather-error-tip">
          <text>âš ï¸ {{weatherForecast30d.errorMessage}}</text>
        </view>
        <scroll-view class="weather-forecast" scroll-x="true">
          <view class="forecast-list">
            <view 
              class="forecast-item {{item.isInTripRange ? 'is-trip-date' : ''}}"
              wx:for="{{weatherForecast30d.forecast}}" 
              wx:key="date"
            >
              <text class="forecast-date">{{item.formattedDate}}</text>
              <view class="forecast-info">
                <view class="forecast-icons">
                  <image wx:if="{{item.iconDay}}" class="forecast-icon" src="{{item.iconDay}}" mode="aspectFit" />
                  <image wx:if="{{item.iconNight}}" class="forecast-icon forecast-icon-night" src="{{item.iconNight}}" mode="aspectFit" />
                </view>
                <view class="forecast-temp">
                  <text class="temp-max">{{item.tempMax}}Â°</text>
                  <text class="temp-min">/ {{item.tempMin}}Â°</text>
                </view>
                <view class="forecast-text">
                  <text class="forecast-text-day">{{item.textDay}}</text>
                  <text wx:if="{{item.textNight && item.textNight !== item.textDay}}" class="forecast-text-night">{{item.textNight}}</text>
                </view>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>

      <view wx:elif="{{weatherError}}" class="weather-error">
        <text>âš ï¸ {{weatherError}}</text>
      </view>
    </view>

    <button 
      class="submit-btn" 
      type="primary" 
      loading="{{loading}}"
      bindtap="handleCreate"
    >
      åˆ›å»ºè¡Œç¨‹
    </button>
  </scroll-view>

  <!-- åŸå¸‚é€‰æ‹©å¼¹çª— -->
  <view wx:if="{{cityDialogVisible}}" class="city-dialog-mask" bindtap="confirmSelectCity">
    <view class="city-dialog" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">é€‰æ‹©ç›®çš„åœ°åŸå¸‚</text>
        <text class="dialog-close" bindtap="confirmSelectCity">Ã—</text>
      </view>
      <view class="dialog-content">
        <view wx:if="{{cityLoading}}" class="loading-state">
          <text>åŠ è½½åŸå¸‚åˆ—è¡¨...</text>
        </view>
        <view wx:else>
          <view 
            class="city-item {{selectedCityId === item.id ? 'selected' : ''}}" 
            wx:for="{{cityList}}" 
            wx:key="id"
            bindtap="handleSelectCityRow"
            data-city="{{item}}"
            data-id="{{item.id}}"
          >
            <text class="city-name">{{item.name}}</text>
            <text class="city-region">{{item.adm2 || item.adm1}} {{item.country}}</text>
            <text wx:if="{{selectedCityId === item.id}}" class="city-selected-icon">âœ“</text>
          </view>
          <view wx:if="{{cityList.length === 0}}" class="empty-state">
            <text>æš‚æ— æ•°æ®</text>
          </view>
        </view>
      </view>
      <view class="dialog-footer">
        <button class="dialog-btn" bindtap="closeCityDialog">å–æ¶ˆ</button>
        <button class="dialog-btn primary" bindtap="confirmSelectCity" disabled="{{!selectedCityId}}">ç¡®è®¤</button>
      </view>
    </view>
  </view>
</view>
